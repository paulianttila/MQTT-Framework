---

test_name: Make sure framework works

paho-mqtt: &mqtt_spec
  client:
    transport: tcp
  connect:
    host: localhost
    port: 1883

stages:
  - name: test basic MQTT messaging
    mqtt_publish:
      topic: 'myapp/request'
      payload: 'test_message'
    mqtt_response:
      topic: 'myapp/response'
      payload: 'test_message'
      timeout: 3

  - name: test updateNow triggering
    mqtt_publish:
      topic: 'myapp/updateNow'
      payload: 'true'
    mqtt_response:
      topic: 'myapp/manual_trigger_counter_updated'
      payload: 'now'
      timeout: 3

  - name: test configuration variable
    mqtt_publish:
      topic: 'myapp/config_variable_request'
      payload: 'true'
    mqtt_response:
      topic: 'myapp/config_variable_response'
      payload: '123456'
      timeout: 3

  - name: test updateNow triggering value
    mqtt_publish:
      topic: 'myapp/updateNow'
      payload: 'true'
    mqtt_response:
      topic: 'myapp/manual_trigger_counter'
      payload: '2'
      timeout: 3

  - name: test jobs interface
    request:
      url: http://localhost:8080/jobs
      method: GET
      timeout: 3
    response:
      status_code: 200

  - name: test healthy check OK
    request:
      url: http://localhost:8080/healthy
      method: GET
      timeout: 3
    response:
      status_code: 200

  - name: set healthy check to be failed
    mqtt_publish:
      topic: 'myapp/healthy_check_state'
      payload: 'False'
    mqtt_response:
      topic: 'myapp/healthy_check_state_response'
      payload: 'False' 
      timeout: 3

  - name: test healthy check Failure
    request:
      url: http://localhost:8080/healthy
      method: GET
      timeout: 3
    response:
      status_code: 500

  - name: test custom url support
    request:
      url: http://localhost:8080/json
      method: GET
      timeout: 3
    response:
      status_code: 200
      json:
        id: 1
        message: 'json example data'

  - name: test rest update
    request:
      url: http://localhost:8080/update
      method: GET
      timeout: 3
    response:
      status_code: 200
    mqtt_response:
      topic: 'myapp/manual_trigger_counter'
      payload: '3'
      timeout: 3

  - name: test metrics
    request:
      url: http://localhost:8080/metrics
      method: GET
      timeout: 3
    response:
      status_code: 200
      verify_response_with:
        function: testing_utils:check_metrics

  - name: test interval triggering value
    mqtt_publish:
      topic: 'myapp/dummy'
      payload: 'true'
    mqtt_response:
      topic: 'myapp/interval_trigger_counter'
      timeout: 3
      verify_response_with:
        function: testing_utils:check_mqtt_response
